#####################################################################
# AUTOMATISIERUNG & SILENT-LOGIK (Chiron Optimiert)
#####################################################################

[gcode_macro _SILENT_VARS]
variable_silent_start: 22      # Ab welcher Stunde (z.B. 22 Uhr)
variable_silent_end: 7         # Bis zu welcher Stunde (z.B. 7 Uhr)
variable_silent_ratio: 0.5     # Drosselung (0.5 = 50% Leistung)
variable_manual_mode: "auto"   # "auto", "silent", "normal"
variable_current_ratio: 1.0    # AKTUELLER FAKTOR (NEU)
gcode:
    # Container für Variablen

[gcode_macro SET_SILENT_MODE]
description: Setzt den Silent-Modus manuell (MODE=auto|silent|normal)
gcode:
    {% set mode = params.MODE|default("auto")|lower %}
    {% if mode in ["auto", "silent", "normal"] %}
        SET_GCODE_VARIABLE MACRO=_SILENT_VARS VARIABLE=manual_mode VALUE='"{mode}"'
        {action_respond_info("Silent Mode wurde auf '%s' gesetzt." % mode)}
    {% else %}
        {action_respond_info("Fehler: Modus '%s' unbekannt. Nutze auto, silent oder normal." % mode)}
    {% endif %}

[gcode_macro CHECK_SILENT_TIME]
description: Entscheidet basierend auf Zeit oder manuellem Override
gcode:
    {% set vars = printer["gcode_macro _SILENT_VARS"] %}
    {% set hour = params.HOUR|default(-1)|int %}
    {% set mode = vars.manual_mode %}

    {% if mode == "silent" %}
        {action_respond_info("Silent Mode: MANUELL ERZWUNGEN")}
        _APPLY_SILENT_PERCENT P={vars.silent_ratio}
    {% elif mode == "normal" %}
        {action_respond_info("Silent Mode: MANUELL DEAKTIVIERT")}
        _APPLY_SILENT_PERCENT P=1.0
    {% else %}
        # Automatischer Modus
        {% if hour == -1 %}
            {action_respond_info("Silent Mode Auto: Keine Stunde vom Slicer erhalten. Nutze Normal-Modus.")}
            _APPLY_SILENT_PERCENT P=1.0
        {% else %}
            {% if (hour >= vars.silent_start) or (hour < vars.silent_end) %}
                {action_respond_info("Silent Mode Auto: Nachtzeit erkannt (Stunde %d). Drosselung aktiv." % hour)}
                _APPLY_SILENT_PERCENT P={vars.silent_ratio}
            {% else %}
                {action_respond_info("Silent Mode Auto: Tagzeit erkannt (Stunde %d). Volle Leistung." % hour)}
                _APPLY_SILENT_PERCENT P=1.0
            {% endif %}
        {% endif %}
    {% endif %}

[gcode_macro _APPLY_SILENT_PERCENT]
description: Wendet die Drosselung auf die Drucker-Limits an
gcode:
    {% set ratio = params.P|float %}
    SET_GCODE_VARIABLE MACRO=_SILENT_VARS VARIABLE=current_ratio VALUE={ratio}
    
    {% set settings = printer.configfile.settings.printer %}
    
    # Basiswerte aus der printer.cfg holen
    {% set max_accel = settings.max_accel %}
    {% set max_vel = settings.max_velocity %}
    {% set scv = settings.square_corner_velocity %}

    # Neue Limits setzen (via Base-Befehl um Loop zu vermeiden)
    SET_VELOCITY_LIMIT_BASE ACCEL={max_accel * ratio} VELOCITY={max_vel * ratio} SQUARE_CORNER_VELOCITY={scv * ratio}
    
    {% if ratio < 1.0 %}
        M117 Silent Mode: {(ratio * 100)|int}%
    {% else %}
        M117 Normal Mode
    {% endif %}

#####################################################################
# SLICER OVERRIDES (Verhindert Überschreiben der Silent-Limits)
#####################################################################

[gcode_macro M204]
description: Skaliert Beschleunigung vom Slicer
rename_existing: M204.1
gcode:
    {% set ratio = printer["gcode_macro _SILENT_VARS"].current_ratio|default(1.0)|float %}
    {% if 'S' in params %}
        {% set s = params.S|float * ratio %}
        SET_VELOCITY_LIMIT_BASE ACCEL={s} ACCEL_TO_DECEL={s / 2.0}
    {% elif 'P' in params %}
        {% set p = params.P|float * ratio %}
        SET_VELOCITY_LIMIT_BASE ACCEL={p} ACCEL_TO_DECEL={p / 2.0}
    {% endif %}

[gcode_macro SET_VELOCITY_LIMIT]
description: Skaliert Geschwindigkeitslimits vom Slicer
rename_existing: SET_VELOCITY_LIMIT_BASE
gcode:
    {% set ratio = printer["gcode_macro _SILENT_VARS"].current_ratio|default(1.0)|float %}
    {% set v = params.VELOCITY|default(-1)|float %}
    {% set a = params.ACCEL|default(-1)|float %}
    {% set atd = params.ACCEL_TO_DECEL|default(-1)|float %}
    {% set scv = params.SQUARE_CORNER_VELOCITY|default(-1)|float %}

    {% set out = "" %}
    {% if v != -1 %} {% set out = out ~ " VELOCITY=" ~ (v * ratio) %} {% endif %}
    {% if a != -1 %} {% set out = out ~ " ACCEL=" ~ (a * ratio) %} {% endif %}
    {% if atd != -1 %} {% set out = out ~ " ACCEL_TO_DECEL=" ~ (atd * ratio) %} {% endif %}
    {% if scv != -1 %} {% set out = out ~ " SQUARE_CORNER_VELOCITY=" ~ (scv * ratio) %} {% endif %}
    
    {% if out != "" %}
        SET_VELOCITY_LIMIT_BASE {out}
    {% endif %}

[gcode_macro RESET_SILENT_MODE]
description: Setzt alle Limits auf 100% zurück
gcode:
    _APPLY_SILENT_PERCENT P=1.0
    M117 Silent Mode OFF

[gcode_macro TEST_SILENT_LOGIC]
description: Testet die Logik mit einer fiktiven Stunde (Stunde=XX)
gcode:
    {% set test_hour = params.HOUR|default(12)|int %}
    {action_respond_info("--- TEST DER SILENT LOGIK ---")}
    {action_respond_info("Test-Stunde: %d" % test_hour)}
    CHECK_SILENT_TIME HOUR={test_hour}

